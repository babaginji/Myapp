<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='feed.css') }}">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>

<header>
    <h1>
        <a href="#" id="site-name">I comunication â–¼</a>
    </h1>

    <div class="feature-links" id="feature-links">
        <a href="{{ url_for('ai_diagnosis.ai_home') }}">AIè¨ºæ–­ã¸</a>
        <a href="{{ url_for('invest_clock.clock_home') }}">è¤‡åˆ©æ™‚è¨ˆ</a>
        <a href="https://investment-books.onrender.com">æœ¬æ£š</a>
        <a href="#">è¤‡åˆ©è¨ˆç®—</a>
    </div>

    <nav class="top-nav">
        <a href="#"><img src="{{ url_for('static', filename='images/tuuchi.jpg') }}" alt="é€šçŸ¥" class="top-nav-icon"></a>
        <a href="#"><img src="{{ url_for('static', filename='images/DM.jpg') }}" alt="DM" class="top-nav-icon"></a>
    </nav>
</header>

<main class="feed-container">

    {% for post in posts %}
    <div class="tweet-card" id="post-{{ post.id }}">
    
        <div class="tweet-header">
            <img src="{{ url_for('static', filename='icons/' + (post.user.icon or 'default.png')) }}" class="tweet-icon">

            <div class="tweet-user-info">
                <span class="tweet-username">{{ post.user.username }}</span>
                <span class="tweet-date">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
        </div>
    
        <div class="tweet-content">
            <p class="tweet-text">{{ post.content }}</p>
        </div>
    
        <div class="tweet-actions">
            {% if current_user.is_authenticated %}
                <button class="action-btn" onclick="openCommentBox({{ post.id }})">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</button>
                <button class="action-btn" onclick="sendRepost({{ post.id }})">ğŸ” è»¢é€</button>
                <button class="action-btn like-btn {% if current_user.is_authenticated and post.is_liked_by(current_user) %}liked{% endif %}" 
        id="like-btn-{{ post.id }}" onclick="toggleLike({{ post.id }})">
    <span class="heart">â¤ï¸</span> 
    <span class="like-count" id="like-count-{{ post.id }}">{{ post.likes.count() }}</span>
</button>


                
            {% else %}
                <button class="action-btn" onclick="alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„')">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</button>
                <button class="action-btn" onclick="alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„')">ğŸ” è»¢é€</button>
                <button class="action-btn" onclick="alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„')">â¤ï¸ ã„ã„ã­</button>
            {% endif %}
        </div>
        
        
        <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
<div class="comment-box-scroll">
    {% for comment in post.ordered_comments %}
    <p class="comment-text">{{ comment.user.username }}: {{ comment.content }}</p>
    {% endfor %}
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›æ¬„ -->
{% if current_user.is_authenticated %}
<div class="comment-input-box">
    <input type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ãâ€¦" id="comment-input-{{ post.id }}">
    <button onclick="postComment({{ post.id }})">é€ä¿¡</button>
</div>
{% else %}
<p style="color:#888; font-size:14px; margin-top:5px;">
    ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯<a href="{{ url_for('auth.login') }}">ãƒ­ã‚°ã‚¤ãƒ³</a>ã—ã¦ãã ã•ã„
</p>
{% endif %}


    </div>
    {% else %}
    <p>æŠ•ç¨¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endfor %}

</main>

<footer>
    <nav class="bottom-nav">
        <a href="#">ãƒ›ãƒ¼ãƒ </a>
        <a href="#">æ¢ã™</a>
        <a href="{{ url_for('post.create_post') }}">æŠ•ç¨¿</a>
        <a href="#">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</a>
        <a href="{{ url_for('auth.profile') }}">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
    </nav>
</footer>

<script>
const siteName = document.getElementById("site-name");
const featureLinks = document.getElementById("feature-links");

siteName.addEventListener("click", (event) => {
    event.preventDefault();
    featureLinks.style.display = (featureLinks.style.display === "flex") ? "none" : "flex";
});

document.addEventListener("click", (event) => {
    if (!siteName.contains(event.target) && !featureLinks.contains(event.target)) {
        featureLinks.style.display = "none";
    }
});

const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

function toggleLike(postId) {
    const btn = document.getElementById(`like-btn-${postId}`);
    fetch(`/feed/like/${postId}`, {
        method: "POST",
        headers: {"X-CSRFToken": csrfToken}
    })
    .then(res => res.json())
    .then(data => {
        if(data.count !== undefined) {
            document.getElementById(`like-count-${postId}`).textContent = data.count;
        }
        if(data.liked) {
            btn.classList.add("liked");
        } else {
            btn.classList.remove("liked");
        }
    });
}


function sendRepost(postId) {
    fetch(`/feed/repost/${postId}`, {
        method: "POST",
        headers: {"X-CSRFToken": csrfToken}
    })
    .then(res => res.json())
    .then(data => console.log("REPOST:", data));
}

function openCommentBox(postId) {
    let box = document.getElementById(`comment-box-${postId}`);
    box.style.display = (box.style.display === "none") ? "block" : "none";
}

function postComment(postId) {
    let input = document.getElementById(`comment-input-${postId}`);
    let text = input.value.trim();
    if(!text) return;

    fetch(`/feed/comment/${postId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({content: text})
    })
    .then(res => res.json())
    .then(data => {
        if(data.ok) {
            input.value = "";
            const postDiv = document.getElementById(`post-${postId}`);
            const commentList = postDiv.querySelector(".comment-list");

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸHTMLã§å·®ã—æ›¿ãˆ
            commentList.innerHTML = data.comments_html;
        } else {
            alert(data.error || "ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡å¤±æ•—");
        }
    });
}

function toggleComments(btn) {
    const hiddenComments = btn.parentElement.querySelectorAll('.comment-hidden');
    hiddenComments.forEach(p => {
        p.style.display = (p.style.display === 'none') ? 'block' : 'none';
    });
    btn.textContent = btn.textContent.includes('è¡¨ç¤º') ? 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’éš ã™â–²' : 'ä»–ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºâ–¼';
}
</script>

</body>
</html>
